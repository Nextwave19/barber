<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HairBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .navbar { background-color: #f8f9fa; }
    .admin-btn { margin-left: 10px; }
    .chat-box { height: 200px; overflow-y: scroll; background: #f1f1f1; padding: 10px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">HairBoss</a>
    <div class="d-flex">
      {% if username %}
        <span class="navbar-text me-3">שלום {{ username }}</span>
        {% if is_admin %}
        <a href="/admin-command-panel" class="btn btn-danger admin-btn">Admin Command</a>
        {% endif %}
        <a href="/logout" class="btn btn-outline-secondary">Logout</a>
      {% else %}
        <a href="/login" class="btn btn-outline-primary">Login</a>
      {% endif %}
    </div>
  </div>
</nav>

<div class="container mt-5">
  <h2>קביעת תור</h2>
  <form id="bookingForm">
    <div class="mb-3">
      <label for="name" class="form-label">שם מלא</label>
      <input type="text" class="form-control" id="name" required>
    </div>
    <div class="mb-3">
      <label for="phone" class="form-label">טלפון</label>
      <input type="tel" class="form-control" id="phone" required>
    </div>
    <div class="mb-3">
      <label for="service" class="form-label">שירות</label>
      <select class="form-control" id="service">
        <option>Men's Haircut</option>
        <option>Women's Haircut</option>
        <option>Blow Dry</option>
        <option>Color</option>
      </select>
    </div>
    <div class="row">
      <div class="col">
        <label for="date" class="form-label">תאריך</label>
        <select class="form-control" id="date"></select>
      </div>
      <div class="col">
        <label for="time" class="form-label">שעה</label>
        <select class="form-control" id="time"></select>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">קבע תור</button>
  </form>

  <div id="response" class="mt-3"></div>

  <hr>

  <h2>שאל את הבוט</h2>
  <div class="chat-box" id="chat"></div>
  <form id="chatForm" class="d-flex mt-2">
    <input type="text" id="message" class="form-control me-2" placeholder="שאל שאלה...">
    <button type="submit" class="btn btn-success">שאל</button>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch("/availability")
      .then(res => res.json())
      .then(data => {
        const dateSelect = document.getElementById("date");
        Object.keys(data).forEach(date => {
          const opt = document.createElement("option");
          opt.value = opt.text = date;
          dateSelect.add(opt);
        });

        dateSelect.addEventListener("change", () => {
          const timeSelect = document.getElementById("time");
          timeSelect.innerHTML = "";
          data[dateSelect.value].forEach(time => {
            const opt = document.createElement("option");
            opt.value = opt.text = time;
            timeSelect.add(opt);
          });
        });

        dateSelect.dispatchEvent(new Event("change"));
      });

    document.getElementById("bookingForm").addEventListener("submit", e => {
      e.preventDefault();
      const body = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value,
        service: document.getElementById("service").value
      };

      fetch("/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("response").innerText = data.message || data.error;
      });
    });

    document.getElementById("chatForm").addEventListener("submit", e => {
      e.preventDefault();
      const message = document.getElementById("message").value;
      const chat = document.getElementById("chat");
      chat.innerHTML += `<div><strong>אתה:</strong> ${message}</div>`;

      fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      })
      .then(res => res.json())
      .then(data => {
        chat.innerHTML += `<div><strong>בוט:</strong> ${data.answer}</div>`;
        chat.scrollTop = chat.scrollHeight;
        document.getElementById("message").value = "";
      });
    });
  });
</script>
</body>
</html>
